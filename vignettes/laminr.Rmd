---
title: "Getting started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
# whether or not this code will be used to
# actually upload results to the LaminDB instance
# -> testuser1 is a test account that cannot upload results
submit_eval <- laminr:::.get_user_settings()$handle != "testuser1"
```

# Introduction

This vignettes provides a quick introduction to the **{laminr}** workflow.
For more details about how **{laminr}** works see `vignette("concepts_features", package = "laminr")`.

# Installation

Install **{laminr}** from CRAN using:

```r
install.packages("laminr")
```

You will also need to install the `lamindb` Python package:

```bash
pip install lamindb[aws]
```

Some functionality requires additional packages.
You will be prompted to install them as needed or you can install them all now with:

```r
install.packages("laminr", dependencies = TRUE)
```

See the "Initial setup" section of `vignette("concepts_features", package = "laminr")` for more details.

# Connecting to LaminDB

Load **{laminr}** to get started.

```{r library}
library(laminr)
```

## Connect to the default instance

The default LaminDB instance is set using the `lamin` CLI on the command line:

```shell
lamin connect <owner>/<name>
```

Once a default instance has been set, we can connect to it with **{laminr}**:

```{r connect-default}
db <- connect()
db
```

<div class="alert alert-warning" role="alert">
**Note**

Only the default instance can create new records.
This tutorial assumes you have access to an instance where you have permission to add data.
</div>

## Connect to other instances

It is possible to connect to non-default instances by providing a slug to the `connect()` function.
Instances connected to in this way can be used to query data but cannot make any changes.
Let's connect to the public CELLxGENE instance:

```{r connect-cellxgene}
cellxgene <- connect("laminlabs/cellxgene")
cellxgene
```

# Track data provenance

LaminDB can track which scripts or notebooks were used to create data.
This command starts the tracking process.

```{r track, eval = submit_eval}
db$track("I8BlHXFXqZOG0000", path = "laminr.Rmd")
```

<div class="alert alert-info" role="alert">
**Tip**

The ID should be obtained by running `db$track(path = "your_file.R")` and copying the ID from the output.
</div>

# Download a dataset

Artifacts are objects that contain information (single-cell data, images, data frames etc.) as well as associated metadata.

```{r get-artifact}
artifact <- cellxgene$Artifact$get("7dVluLROpalzEh8mNyxk")
artifact
```

<div class="alert alert-info" role="alert">
**Tip**

You can view information about this dataset at https://lamin.ai/laminlabs/cellxgene/artifact/7dVluLROpalzEh8mNyxk.
This website can also be used to search for other CELLxGENE datasets.
</div>

So far we have only retrieved the metadata about this artifact.
To download the data itself we need to run another command.

```{r load-artifact}
adata <- artifact$load()
adata
```

You can see that this artifact contains an [`AnnData`](https://anndata.readthedocs.io) object.

# Work with the data

Once you have loaded a dataset you can perform any analysis with it as you would normally.
As a quick example we calculate marker genes for each of the provided cell type labels using [**{Seurat}**](https://satijalab.org/seurat/).

```{r create-seurat}
# Create a Seurat object
seurat <- SeuratObject::CreateSeuratObject(
  counts = as(Matrix::t(adata$X), "CsparseMatrix"),
  meta.data = adata$obs,
)
# Set cell identities to the provided cell type annotation
SeuratObject::Idents(seurat) <- "Cell_Type"
# Normalise the data
seurat <- Seurat::NormalizeData(seurat)
# Test for marker genes (the output is a data.frame)
markers <- Seurat::FindAllMarkers(
  seurat,
  features = SeuratObject::Features(seurat)[1:100] # Only test a few features for speed
)
# Display the marker genes
knitr::kable(markers)
# Plot the marker genes
Seurat::DotPlot(seurat, features = unique(markers$gene)) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5))
```

# Store the results in LaminDB

Any results can be saved to the default LaminDB instance.

```{r save-results, eval = submit_eval}
seurat_path <- tempfile(fileext = ".rds")
saveRDS(seurat, seurat_path)

db$Artifact$from_df(
  markers,
  description = "Marker genes for renal cell carcinoma dataset"
)$save()

db$Artifact$from_path(
  seurat_path,
  description = "Seurat object for renal cell carcinoma dataset"
)$save()
```

# Stop tracking

When we are done we end the tracking run.

```{r finish, eval = submit_eval}
db$finish()
```

# Upload notebooks and code

Running this code with upload the created datasets but not the code itself.
Do do that:

1. Render the notebook to HTML (not needed for `.R` scripts)

- In RStudio, click the "Knit" button
- **OR** From the command line, run:  
  ```bash
  Rscript -e 'rmarkdown::render("laminr.Rmd")'
  ```
- **OR** Use the `rmarkdown` package in R:  
  ```r
  rmarkdown::render("laminr.Rmd")
  ```

2. Save it to your LaminDB instance using the `lamin` CLI:

```bash
lamin save laminr.Rmd
```
