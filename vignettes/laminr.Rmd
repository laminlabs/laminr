---
title: "Get started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
# whether or not this code will be used to
# actually upload results to the LaminDB instance
# -> testuser1 is a test account that cannot upload results
submit_eval <- laminr:::.get_user_settings()$handle != "testuser1"
```

This vignette introduces the basic **{laminr}** workflow.

# Setup

Install **{laminr}** from CRAN:

```r
install.packages("laminr", dependencies = TRUE)
```

Install `lamindb` from PyPI:

```bash
pip install 'lamindb[aws]'
```

Connect to a LaminDB instance on the command line:

```shell
lamin connect <owner>/<name>
```

This instance acts as the default instance for everything that follows.
Any data and tracking information will be added to it.

# Start your analysis

Load **{laminr}** to get started.

```{r library}
library(laminr)
```

Create your default database `db` object for this R session:

```{r connect-default}
db <- connect()
```

It is used to manage all datasets and metadata entities.

LaminDB tracks which code is used to create data.
To track the current source code, run:

```{r track, eval = submit_eval}
db$track("I8BlHXFXqZOG0000", path = "laminr.Rmd")
```

<div class="alert alert-info" role="alert">
**Tip**

The UID (here `"I8BlHXFXqZOG0000"`) is obtained by running `db$track(path = "your_file.R")` and copying the UID from the output.
</div>

# Connect to other instances

It is possible to connect to any LaminDB instance for reading data.
Connect to the public CELLxGENE instance:

```{r connect-cellxgene}
cellxgene <- connect("laminlabs/cellxgene")
cellxgene
```

# Download a dataset

Artifacts are objects that bundle data and associated metadata.
An artifact can be any file or folder but is typically a dataset.

```{r get-artifact}
artifact <- cellxgene$Artifact$get("7dVluLROpalzEh8mNyxk")
artifact
```

<div class="alert alert-info" role="alert">
**Tip**

You can view detailed information about this dataset on LaminHub: https://lamin.ai/laminlabs/cellxgene/artifact/7dVluLROpalzEh8mNyxk.

You can search and query more CELLxGENE datasets here: https://lamin.ai/laminlabs/cellxgene/artifacts.
</div>

To download the dataset and load it into memory, run:

```{r load-artifact}
adata <- artifact$load()
adata
```

This artifact contains an [`AnnData`](https://anndata.readthedocs.io) object.

<div class="alert alert-info" role="alert">
**Tip**

If you prefer a path to a local file or folder, call `path <- artifact$cache()`.
</div>

# Work with the dataset

Once you have loaded a dataset you can perform any analysis with it as you would normally.
Here, marker genes are calculated for each of the provided cell type labels using [**{Seurat}**](https://satijalab.org/seurat/).

```{r create-seurat}
# Create a Seurat object
seurat_obj <- SeuratObject::CreateSeuratObject(
  counts = as(Matrix::t(adata$X), "CsparseMatrix"),
  meta.data = adata$obs
)
# add gene metadata
seurat_obj[["RNA"]] <- AddMetaData(GetAssay(seurat_obj), adata$var)
# Set cell identities to the provided cell type annotation
SeuratObject::Idents(seurat_obj) <- "cell_type"
# Normalise the data
seurat_obj <- Seurat::NormalizeData(seurat_obj)
# Test for marker genes (the output is a data.frame)
markers <- Seurat::FindAllMarkers(
  seurat_obj,
  features = SeuratObject::Features(seurat_obj)[1:100] # Only test a few features for speed
)
# Display the marker genes
knitr::kable(markers)
# Plot the marker genes
Seurat::DotPlot(seurat_obj, features = unique(markers$gene)) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5))
```

# Slice the tiledbsoma array store

Alternatively to querying individual datasets, you can also slice the `.tiledbsoma` array store, which stores Census, a concatenated version of most datasets in CELLxGENE.

```{r slice-tiledb}

library("cellxgene.census")

census <- open_soma()

organism <- "Homo sapiens"
gene_filter <- "feature_id %in% c('ENSG00000107317', 'ENSG00000106034')"
cell_filter <-  "cell_type == 'sympathetic neuron'"
cell_columns <- c("assay", "cell_type", "tissue", "tissue_general", "suspension_type", "disease")

seurat_obj2 <- get_seurat(
   census = census,
   organism = organism,
   var_value_filter = gene_filter,
   obs_value_filter = cell_filter,
   obs_column_names = cell_columns
)
```

# Save the results

Save results as new artifacts to the default LaminDB instance.

```{r save-results, eval = submit_eval}
seurat_path <- tempfile(fileext = ".rds")
saveRDS(seurat_obj, seurat_path)

db$Artifact$from_df(
  markers,
  description = "Marker genes for renal cell carcinoma dataset"
)$save()

db$Artifact$from_path(
  seurat_path,
  description = "Seurat object for renal cell carcinoma dataset"
)$save()
```

# Mark the analysis as finished

Mark the analysis run as finished to create a time stamp and upload source code to the hub.

```{r finish, eval = submit_eval}
db$finish()
```

## Save a notebook report (not needed for `.R` scripts)

Save a run report of your notebook (`.Rmd` or `.qmd` file) to your instance:

1. Render the notebook to HTML

- In RStudio, click the "Knit" button
- **OR** From the command line, run:

  ```bash
  Rscript -e 'rmarkdown::render("laminr.Rmd")'
  ```

- **OR** Use the `rmarkdown` package in R:

  ```r
  rmarkdown::render("laminr.Rmd")
  ```

2. Save it to your LaminDB instance using the `lamin` CLI:

```bash
lamin save laminr.Rmd
```

# Further reading

For more details about how **{laminr}** works see `vignette("concepts_features", package = "laminr")`.
